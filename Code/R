---
title: "project3"
author: "team 6"
date: "3/4/2021"
output: html_document
---
```{r include = FALSE,warning=FALSE,message=FALSE,error=FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r,message=FALSE}
library(tidyverse)
library(gridExtra)
library(scales)
library(lubridate)
library(ggplot2)
```

## Abstract

This report simply summaries the Covid-19 cases and death verse time, region, and transmission by some plots, and analyzes the relationship between the number of Covid-19 confirmed cases and some variables such as some underlying disease that we are interested in. It also summarizes the results of statistical modeling and validated the model assumptions we made. We are trying to investigate the causal inference and association between the Covid-19 infection rate and other factors.


## Introduction

```{r,message=FALSE}
#import WHO-ocovid-19data 
data <-read_csv("https://covid19.who.int/WHO-COVID-19-global-data.csv")
colnames(data) <- c('date','country_code','country','WHO_region','New_cases','Cumulative_cases','New_deaths','Cumulative_deaths')
data$date<- as.Date(data$date,format="%m/%d/%Y")
```

```{r}
#check missing value
sum(is.na(data))

#process missing value
data = na.omit(data)
```

#### plot1 map
```{r,message=FALSE}
#world map
library(maps)
world <- map_data("world");
worldplot <- ggplot() +
  geom_polygon(data = world, aes(x=long, y = lat, group = group)) 

```

```{r}

data.today<- data %>% 
  filter(date == "2021-2-28") %>% 
 mutate(region=country)
world[world=="USA"]<-"United States of America"
world[world=="Bolivia"]<-"Bolivia (Plurinational State of)"
world[world=="Virgin Islands"]<-"British Virgin Islands"
world[world=="Cape Verde"]<-"Cabo Verde" 
world[world=="Republic of the Congo"]<-"Congo"     
world[world=="Ivory Coast"]<-"Côte d’Ivoire"  
world[world=="Curacao"]<-"Curaçao"       
world[world=="Czech Republic"]<-"Czechia"
world[world=="North Korea"]<-"Democratic People's Republic of Korea"
world[world=="Swaziland"]<-"Eswatini"
world[world=="Falkland Islands"]<-"Falkland Islands (Malvinas)"

world[world=="Tobago"]<-"Trinidad and Tobago"
world[world=="Tanzania"]<-"United Republic of Tanzania"
world[world=="Venezuela"]<-"Venezuela (Bolivarian Republic of)"
world[world=="Vietnam"]<-"Viet Nam"
world[world=="Tobago"]<-"Trinidad and Tobago"
world[world=="Tanzania"]<-"United Republic of Tanzania"
world[world=="Venezuela"]<-"Venezuela (Bolivarian Republic of)"
world[world=="Vietnam"]<-"Viet Nam"

world[world=="Iran"]<-"Iran (Islamic Republic of)"
world[world=="Kosovo"]<-"Kosovo[1]"
world[world=="Laos"]<-"Lao People's Democratic Republic"
world[world=="Micronesia"]<-"Micronesia (Federated States of)"
world[world=="South Korea"]<-"Republic of Korea"
world[world=="Moldova"]<-"Republic of Moldova"
world[world=="Reunion"]<-"Réunion"
world[world=="Saint Barthelemy"]<-"Saint Barthélemy"
world[world=="UK"]<-"The United Kingdom"

data.today.world<- inner_join(world, data.today, by = "region")

# Map
fig.map  <- ggplot() +
  geom_polygon(data = data.today.world, aes(x=long, y = lat, group = group,fill=Cumulative_deaths)) + 
  coord_fixed(1.3)
fig.map
```

#### plot2

```{r,message=FALSE}
library(plotly)
p<- data.frame(data$date, data$New_cases, data$New_deaths)
fig <- plot_ly(p, x = ~data$date, y =data$New_deaths , type = 'bar', name = 'New deaths')
fig <- fig %>% add_trace(y = ~data$New_cases, name = 'New Case')
fig <- fig %>% layout(yaxis = list(title = 'Cases'), barmode = 'stack')
fig
```

#### plot3

```{r,message=FALSE}
library(plotly)
p1<- data.frame(data$date, data$Cumulative_cases, data$Cumulative_deaths)
fig1<- plot_ly(p1, x = ~data$date, y =data$Cumulative_deaths, type = 'bar', name = 'Cumulative deaths')
fig1<- fig1 %>% add_trace(y = ~data$Cumulative_cases, name = 'Cumulative Case')
fig1<- fig1%>% layout(yaxis = list(title = 'Cases'), barmode = 'stack')
fig1
```


#### plot4
```{r}
data1=aggregate(data$New_cases, by=list(data$date),FUN=sum)
data2=aggregate(data$New_deaths, by=list(data$date),FUN=sum)
colnames(data1)=c("date","new cases")
colnames(data2)=c("date","new death")
data3=merge(data1,data2)
data3=data3[(17:426),]
data3$rate=data3$`new death`/data3$`new cases`

data4=aggregate(data$Cumulative_cases, by=list(data$date),FUN=sum)
data5=aggregate(data$Cumulative_deaths, by=list(data$date),FUN=sum)
colnames(data4) <- c("date","cases")
colnames(data5) <- c("date","deaths")
data6=merge(data4,data5)
data6=data6[(9:426),]
data6$rate=data6$deaths/data6$cases

colors <- c("Daily Mortality Rate" = "red", "Cumulative Mortality Rate" = "steelblue")
ggplot()+
  geom_line(data=data3,aes(x=date,y=rate,col="Daily Mortality Rate"))+
geom_line(data=data6,aes(date, y=rate,col="Cumulative Mortality Rate"))+
labs(x = "Date",y = "Mortality Rate",color = "Legend")+
scale_color_manual(values = colors)+
theme(legend.position=c(.86, .89))


```



### covid-19 data set summary statistics

```{r}
setwd("~/Desktop/stat207")
mydata=read.csv("~/Desktop/stat207/covid.csv")
#process missing value
mydata = na.omit(mydata)
#data reduction
mydata=mydata[,-c(5,6,7,10,11,12)]
```

#### data processing

```{r}
#rename
colnames(mydata)=c("contry","region",'cm_cases','cm_cases_p','cm_deaths','cm_death_p', 'transmission','kidneys','smoke','diabetes','TB','Obesity','DevelopedCT')

mydata=subset(mydata,mydata$cm_death_p!=0)
mydata$kidneys=as.numeric(mydata$kidneys)/1000
mydata$TB=mydata$TB/1000

mydata$inferate=mydata$cm_cases_p/1000
```

#### plot5

```{r}
#The relationship between region, transmission and cumulative cases per 100000
ggplot(mydata,aes(x=region,y=cm_cases_p))+
  geom_bar(aes(fill=transmission),stat="identity",position="dodge")+labs(x="Region",y="Cumulative Cases per 100000")+
  theme(legend.position=c(.86, .83))
```


#### relevel disease variables to categorical

```{r}
mydata$kidneys1[mydata$kidneys >= 5.034   & mydata$kidneys < 7.292 ] = "1st"
mydata$kidneys1[mydata$kidneys >=7.292    & mydata$kidneys < 9.775   ] = "2nd"
mydata$kidneys1[mydata$kidneys >=9.775    & mydata$kidneys < 10.924] = "3rd"
mydata$kidneys1[mydata$kidneys >=10.924   & mydata$kidneys <= 13.768 ] = "4th"

#group smoke based on quantile
mydata$smoke1[mydata$smoke >= 4.70 & mydata$smoke < 15.55 ] = "1st"
mydata$smoke1[mydata$smoke >=15.55 & mydata$smoke < 22.35] = "2nd"
mydata$smoke1[mydata$smoke >=22.35 & mydata$smoke < 28.05 ] = "3rd"
mydata$smoke1[mydata$smoke >=28.05 & mydata$smoke <= 42.65 ] = "4th"

#group diabetes based on quantile
mydata$diabetes1[mydata$diabetes >= 1.000  & mydata$diabetes < 5.000     ] = "1st"
mydata$diabetes1[mydata$diabetes >=5.000   & mydata$diabetes < 6.300     ] = "2nd"
mydata$diabetes1[mydata$diabetes >=6.300   & mydata$diabetes < 9.200    ] = "3rd"
mydata$diabetes1[mydata$diabetes >=9.200  & mydata$diabetes <= 22.000   ] = "4th"

#group TB based on quantile
mydata$TB1[mydata$TB >= 0.00    & mydata$TB < 0.00870     ] = "1st"
mydata$TB1[mydata$TB >=0.00870  & mydata$TB < 0.03500    ] = "2nd"
mydata$TB1[mydata$TB >=0.03500  & mydata$TB < 0.11700    ] = "3rd"
mydata$TB1[mydata$TB >=0.11700  & mydata$TB <= 0.65400    ] = "4th"

#group obesity based on quantile
mydata$Obesity1[mydata$Obesity >= 2.1    & mydata$Obesity < 8.6      ] = "1st"
mydata$Obesity1[mydata$Obesity >=8.6     & mydata$Obesity < 22.3   ] = "2nd"
mydata$Obesity1[mydata$Obesity >=22.3    & mydata$Obesity < 26.6    ] = "3rd"
mydata$Obesity1[mydata$Obesity >=26.6    & mydata$Obesity <= 37.3    ] = "4th"
```

#### plot6

```{r fig2, fig.height = 6, fig.width = 8, fig.align = "center"}
library(gplots)
# Box plot
g1 <- ggplot(mydata, aes(kidneys1,cm_cases_p,fill=kidneys1))+
geom_boxplot()+
  labs(x = "Quantile of kidneys",y = "Cumulative cases per 10000")

#boxplot for smoke
g2 <- ggplot(mydata, aes(smoke1,cm_cases_p,fill=smoke1))+
geom_boxplot()+
  labs(x = "Quantile of smoke",y = "Cumulative cases per 10000")


#boxplot for diabetes
g3 <- ggplot(mydata, aes(diabetes1,cm_cases_p,fill=diabetes1))+
geom_boxplot()+
  labs(x = "Quantile of diabetes",y = "Cumulative cases per 10000")


#boxplot for TB
g4 <- ggplot(mydata, aes(TB1,cm_cases_p,fill=TB1))+
geom_boxplot()+
  labs(x = "Quantile of TB",y = "Cumulative cases per 10000")


#boxplot for obesity
g5 <- ggplot(mydata, aes(Obesity1,cm_cases_p,fill=Obesity1))+
geom_boxplot()+
  labs(x = "Quantile of obesity",y = "Cumulative cases per 10000")

g6 <- ggplot(data=mydata,aes(x=cm_cases_p,fill=DevelopedCT))+
  geom_density(alpha=.3)

gridExtra::grid.arrange(g1,g2,g3,g4,g5,g6, nrow=3, ncol=2)
```
